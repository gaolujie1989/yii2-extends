<?php /** @noinspection ALL */
/**
 * This is the template for generating the openapi class.
 */

use lujie\otto\helpers\OttoRestApiHelper;
use yii\helpers\ArrayHelper;
use yii\helpers\Inflector;

/* @var $this yii\web\View */
/* @var $generator \lujie\extend\gii\generators\openapi\Generator */
/* @var $openapi array openapi */
/* @var $className string Class Name */

$className = $className ?: Inflector::camelize($openapi['info']['title']);
$urls = ArrayHelper::map($openapi['servers'], 'description', 'url');
$apiBaseUrl = $urls['Live Server'] ?? '';

echo "<?php\n";
?>

namespace <?= $generator->ns ?>;

use Yii;
use Iterator;

/**
* This class is autogenerated by the OpenAPI gii generator
*/
class <?= $className ?> extends <?= '\\' . ltrim($generator->baseClass, '\\') . "\n" ?>
{

    public $apiBaseUrl = '<?= $apiBaseUrl ?>';

<?php foreach ($openapi['paths'] as $path => $pathMethods): ?>
    <?php foreach ($pathMethods as $httpMethod => $method): ?>
    <?php
        $apiMethod = $method['operationId'] ?? null;
        if (empty($apiMethod)) {
            continue;
        }
        $httpMethod = strtoupper($httpMethod);
        $method['tags'] = $method['tags'] ?? [];
        $apiMethod = OttoRestApiHelper::getApiMethodName($apiMethod, $httpMethod);

        $params = ArrayHelper::map($method['parameters'] ?? [], 'name', static function (array $parameter) use ($openapi) {
            $ref = $parameter['$ref'] ?? null;
            if ($ref) {
                $refPath = strtr(substr($ref, 2), ['/' => '.']);
                $component = ArrayHelper::getValue($openapi, $refPath);
                $parameter = array_merge($component, $parameter);
            }
            return [
                'var' => '$' . lcfirst(Inflector::camelize($parameter['name'])),
                'name' => $parameter['name'],
                'required' => $parameter['required'] ?? false,
                'type' => $parameter['schema']['type'] ?? '',
                'description' => strtr($parameter['description'] ?? '', ['<br>' => "\n"]),
            ];
        }, 'in');

        $pathReplaces = [];
        $functionParams = [];
        $docParams = [];

        $pathParams = $params['path'] ?? [];
        foreach ($pathParams as $name => $pathParam) {
            if ($pathParam['type'] === 'array') {
                $pathParam['type'] = 'string';
            }
            $pathReplaces['{' . $name . '}'] = '{' . $pathParam['var'] . '}';

            $functionParams[] = $pathParam['required']
                ? $pathParam['type'] . ' ' . $pathParam['var']
                : '?' . $pathParam['type'] . ' ' . $pathParam['var'] . ' = null';

            $docParams[] = '     * @param ' . $pathParam['type'] . ' ' . $pathParam['var'] . ' ' . $pathParam['description'];
        }
        $apiUrl = strtr($path, $pathReplaces);

        $hasRequiredQuery = false;
        $queryParams = $params['query'] ?? [];
        if ($queryParams) {
            $docParams[] = '     * @param array $query';
            foreach ($queryParams as $name => $param) {
                if ($param['required']) {
                    $hasRequiredQuery = true;
                }
                $required = $param['required'] ? 'required' : 'optional';
                $docParams[] = "     *      - *{$name}* - {$param['type']} - {$required}";
                $docParams[] = "     *          - {$param['description']}";
            }
            $functionParams[] = $hasRequiredQuery ? 'array $query' : 'array $query = []';
        }

        $requestBody = $method['requestBody'] ?? null;
        if ($apiMethod === 'cancelV4Orders') {
            $apiMethod = Inflector::singularize($apiMethod);
        }
        if ($requestBody) {
            $requestContent = reset($requestBody['content']);
            $ref = $requestContent['schema']['$ref'] ?? $requestContent['schema']['items']['$ref'] ?? null;
            $isMulti = isset($requestContent['schema']['items']);
            if ($isMulti) {
                $docParams[] = '     * @param array $data' . ' list of ' . ($requestBody['description'] ?? '');
            } else {
                $apiMethod = Inflector::singularize($apiMethod);
                $docParams[] = '     * @param array $data' . ' ' . ($requestBody['description'] ?? '');
            }
            $functionParams[] = 'array $data';
            if ($ref) {
                $refPath = strtr(substr($ref, 2), ['/' => '.']);
                $component = ArrayHelper::getValue($openapi, $refPath);
                $properties = $component['properties'] ?? [];
                foreach ($properties as $name => $property) {
                    $type = $property['type'] ?? '';
                    $docParams[] = "     *      - *{$name}* - {$type}";
                    $description = $property['description'] ?? '';
                    if ($description) {
                        $docParams[] = "     *          - {$description}";
                    }
                }
            }
        }

        $returnType = ': void';
        $successResponse = null;
        foreach ($method['responses'] as $statusCode => $response) {
            if (str_starts_with($statusCode, '2')) {
                $successResponse = $response;
                break;
            }
        }
        $eachMethod = false;
        $batchMethod = false;
        if ($successResponse && isset($successResponse['content'])) {
            $responseContent = reset($successResponse['content']);
            $type = array_keys($successResponse['content'])[0];
            if (str_contains($type, 'pdf')) {
                $returnType = ': string';
                $docParams[] = '     * @return string';
            } else {
                $ref = $responseContent['schema']['$ref'] ?? $responseContent['schema']['items']['$ref'] ?? null;
                $returnType = ': array';
                $docParams[] = '     * @return array';
            }
            if ($ref) {
                $refPath = strtr(substr($ref, 2), ['/' => '.']);
                $component = ArrayHelper::getValue($openapi, $refPath);
                $properties = $component['properties'] ?? [];
                foreach ($properties as $name => $property) {
                    $type = $property['type'] ?? '';
                    $docParams[] = "     *      - *{$name}* - {$type}";
                    $description = $property['description'] ?? '';
                    if ($description) {
                        $docParams[] = "     *          - {$description}";
                    }
                }
                if ($httpMethod === 'GET' && isset($queryParams['limit'])) {
                    if (str_starts_with($apiMethod, 'get')) {
                        $eachMethod = 'each' . substr($apiMethod, 3);
                        $batchMethod = 'batch' . substr($apiMethod, 3);
                    } else {
                        $eachMethod = 'each' . substr($apiMethod, 4);
                        $batchMethod = 'batch' . substr($apiMethod, 4);
                    }
                }
            }
        }

        $functionParams = implode(', ', $functionParams);
        $docParams = implode("\n", $docParams);

        $apiParams = [];
        if ($queryParams) {
            $apiParams[] = 'array_merge(["' . $apiUrl . '"], $query)';
        } else {
            $apiParams[] = '"' . $apiUrl . '"';
        }
        if ($httpMethod !== 'GET' || $requestBody) {
            $apiParams[] = "'{$httpMethod}'";
        }
        if ($requestBody) {
            $apiParams[] = '$data';
        }
        $apiParams = implode(', ', $apiParams);
    ?>
    <?php if ($eachMethod): ?>

    /**
     * @description <?= $method['description'] . "\n" ?>
     * @tag <?= implode(',', $method['tags']) . "\n" ?>
<?= strtr($docParams, ['@return array' => '@return Iterator']) . "\n" ?>
     */
    public function <?= $eachMethod ?>(<?= $functionParams ?>): Iterator
    {
        return $this->eachInternal('<?= $apiMethod ?>', func_get_args());
    }
    <?php endif; ?>
    <?php if ($batchMethod): ?>

    /**
     * @description <?= $method['description'] . "\n" ?>
     * @tag <?= implode(',', $method['tags']) . "\n" ?>
<?= strtr($docParams, ['@return array' => '@return Iterator']) . "\n" ?>
     */
    public function <?= $batchMethod ?>(<?= $functionParams ?>): Iterator
    {
        return $this->batchInternal('<?= $apiMethod ?>', func_get_args());
    }
    <?php endif; ?>

    /**
     * @description <?= ($method['description'] ?? '') . "\n" ?>
     * @tag <?= implode(',', $method['tags']) . "\n" ?>
<?= $docParams . "\n" ?>
     */
    public function <?= $apiMethod ?>(<?= $functionParams ?>)<?= $returnType . "\n" ?>
    {
        <?= $returnType === ': void' ? '' : 'return ' ?>$this->api(<?= $apiParams ?>);
    }
    <?php endforeach; ?>
<?php endforeach; ?>

}
